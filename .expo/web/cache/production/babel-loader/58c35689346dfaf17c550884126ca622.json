{"ast":null,"code":"import _extends from\"@babel/runtime/helpers/extends\";import _defineProperty from\"@babel/runtime/helpers/defineProperty\";import _slicedToArray from\"@babel/runtime/helpers/slicedToArray\";import _regeneratorRuntime from\"@babel/runtime/regenerator\";function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly){symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});}keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){_defineProperty(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}import{AvatarStyleCount,CompatibleAgents,DefaultBackgroundConfig,ShapeStyleMapping,SVGFilter}from'@/const';import{getRandomStyle}from'@/utils';import Image from'next/image';import{useState,useEffect}from'react';import html2canvas from'html2canvas';import{useRouter}from'next/router';import*as ga from'@/lib/ga';import{useTranslation}from'next-i18next';import SelectionWrapper from'./SelectionWrapper';import DownloadModal from'../Modal/Download';import EmbedModal from'../Modal/Embed';import PaletteModal from'../Modal/Palette';export default function AvatarEditor(){var router=useRouter();var _useState=useState(_objectSpread({},getRandomStyle())),_useState2=_slicedToArray(_useState,2),config=_useState2[0],setConfig=_useState2[1];var _useState3=useState(''),_useState4=_slicedToArray(_useState3,2),preview=_useState4[0],setPreview=_useState4[1];var _useState5=useState('png'),_useState6=_slicedToArray(_useState5,2),imageType=_useState6[0],setImageType=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),showDownloadModal=_useState8[0],setDownloadModal=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),showEmbedModal=_useState10[0],setEmbedModal=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),showPaletteModal=_useState12[0],setPaletteModal=_useState12[1];var _useState13=useState(false),_useState14=_slicedToArray(_useState13,2),flip=_useState14[0],setFlip=_useState14[1];var _useState15=useState(DefaultBackgroundConfig),_useState16=_slicedToArray(_useState15,2),background=_useState16[0],setBackground=_useState16[1];var _useState17=useState('/logo.gif'),_useState18=_slicedToArray(_useState17,2),imageDataURL=_useState18[0],setImageDataURL=_useState18[1];var _useTranslation=useTranslation('common'),t=_useTranslation.t;useEffect(function(){if(router.asPath!==router.route){var _params$flip,_params$color,_params$shape;var query=router.query;var params=Object.keys(query).reduce(function(prev,next){return _extends(prev,_defineProperty({},next,query[next]));},{});setConfig(_objectSpread(_objectSpread({},config),params));setFlip(Boolean(Number((_params$flip=params.flip)!=null?_params$flip:0)));console.log(params);setBackground({color:(_params$color=params.color)!=null?_params$color:'rgba(255, 0, 0, 0)',shape:(_params$shape=params.shape)!=null?_params$shape:'none'});}},[router]);var generatePreview=function generatePreview(flipped){var groups,previewSvg;return _regeneratorRuntime.async(function generatePreview$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return _regeneratorRuntime.awrap(Promise.all(Object.keys(AvatarStyleCount).map(function _callee(type){var svgRaw;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _regeneratorRuntime.awrap(require(\"!!raw-loader!@/public/avatar/preview/\"+type+\"/\"+config[type]+\".svg\"));case 2:svgRaw=_context.sent.default;return _context.abrupt(\"return\",\"\\n<g id=\\\"notion-avatar-\"+type+\"\\\" \"+(type==='face'?'fill=\"#ffffff\"':'')+\" \"+(flipped?'transform=\"scale(-1,1) translate(-1080, 0)\"':'')+\">\\n\\n      \"+svgRaw.replace(/<svg.*(?=>)>/,'').replace('</svg>','')+\"\\n    \\n</g>\\n\");case 4:case\"end\":return _context.stop();}}},null,null,null,Promise);})));case 2:groups=_context2.sent;previewSvg=(\"<svg viewBox=\\\"0 0 1080 1080\\\" fill=\\\"none\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\">\\n      \"+SVGFilter+\"\\n      <g id=\\\"notion-avatar\\\" filter=\\\"url(#filter)\\\">\\n        \"+groups.join('\\n\\n')+\"\\n      </g>\\n      </svg>\").trim().replace(/(\\n|\\t)/g,'');setPreview(previewSvg);case 5:case\"end\":return _context2.stop();}}},null,null,null,Promise);};useEffect(function(){generatePreview(flip);},[config,flip]);var _switchConfig=function switchConfig(type){var newIdx=(config[type]+1)%(AvatarStyleCount[type]+1);config[type]=newIdx;setConfig(_objectSpread({},config));};var downloadAvatar=function downloadAvatar(){var dom,canvas,userAgent,isNeedCompatible,imageURL,svgElement,svg,a;return _regeneratorRuntime.async(function downloadAvatar$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:dom=document.querySelector('#avatar-preview');_context3.next=3;return _regeneratorRuntime.awrap(html2canvas(dom,{logging:false,scale:window.devicePixelRatio,width:dom.offsetWidth,height:dom.offsetHeight}));case 3:canvas=_context3.sent;userAgent=window.navigator.userAgent.toLowerCase();isNeedCompatible=CompatibleAgents.some(function(agent){return userAgent.indexOf(agent)>=0;});ga.event({action:'download',params:_objectSpread({},config)});if(!(imageType==='png')){_context3.next=11;break;}imageURL=canvas.toDataURL();_context3.next=16;break;case 11:svgElement=dom.querySelector('svg');if(svgElement){_context3.next=14;break;}return _context3.abrupt(\"return\");case 14:svg=new XMLSerializer().serializeToString(svgElement);imageURL=\"data:image/svg+xml;base64,\"+window.btoa(svg);case 16:if(!isNeedCompatible){_context3.next=20;break;}setImageDataURL(imageURL);setDownloadModal(true);return _context3.abrupt(\"return\");case 20:a=document.createElement('a');a.href=imageURL;a.download=\"notion-avatar-\"+new Date().getTime()+\".\"+imageType;a.click();case 24:case\"end\":return _context3.stop();}}},null,null,null,Promise);};var onOpenEmbedModal=function onOpenEmbedModal(){setEmbedModal(true);ga.event({action:'embed',params:_objectSpread({},config)});};var onOpenPaletteModal=function onOpenPaletteModal(){setPaletteModal(true);};return React.createElement(React.Fragment,null,showDownloadModal&&React.createElement(DownloadModal,{onCancel:function onCancel(){setDownloadModal(false);},image:imageDataURL}),showEmbedModal&&React.createElement(EmbedModal,{onCancel:function onCancel(){setEmbedModal(false);},config:_objectSpread(_objectSpread({},config),{},{flip:Number(flip),color:background.color,shape:background.shape}),imageType:imageType}),showPaletteModal&&React.createElement(PaletteModal,{onCancel:function onCancel(){setPaletteModal(false);},onSelect:function onSelect(background){setBackground(_objectSpread({},background));setPaletteModal(false);},backgroundConfig:background}),React.createElement(\"div\",{className:\"flex justify-center items-center flex-col\"},React.createElement(\"div\",{style:{backgroundColor:background.shape==='none'?DefaultBackgroundConfig.color:background.color},id:\"avatar-preview\",className:\"w-48 h-48 md:w-72 md:h-72 \"+ShapeStyleMapping[background.shape],dangerouslySetInnerHTML:{__html:preview}}),React.createElement(\"div\",{className:\"w-5/6 md:w-2/3\"},React.createElement(\"div\",{className:\"flex justify-between items-center\"},React.createElement(\"div\",{className:\"text-lg my-5\"},t('choose')),React.createElement(\"div\",null,React.createElement(\"button\",{\"data-tip\":t('flip'),className:\"w-8 h-8 sm:w-12 sm:h-12 tooltip\",onClick:function onClick(){setFlip(!flip);}},React.createElement(Image,{width:30,height:30,src:flip?'/icon/flip-left.svg':'/icon/flip-right.svg'})),React.createElement(\"button\",{\"data-tip\":t('background'),className:\"w-8 h-8 sm:w-12 sm:h-12 tooltip ml-2\",onClick:onOpenPaletteModal},React.createElement(Image,{width:30,height:30,src:\"/icon/palette.svg\"})))),React.createElement(\"div\",{className:\"grid gap-y-4 justify-items-center justify-between grid-rows-2 grid-cols-5 lg:flex\"},Object.keys(AvatarStyleCount).map(function(type){return React.createElement(\"div\",{key:type},React.createElement(SelectionWrapper,{switchConfig:function switchConfig(){_switchConfig(type);},tooltip:t(type)},React.createElement(Image,{src:\"/avatar/part/\"+type+\"/\"+type+\"-\"+config[type]+\".svg\",width:30,height:30})));})),React.createElement(\"div\",{className:\"flex flex-col gap-x-2 md:flex-row mt-8 justify-center  w-full select-none\"},React.createElement(\"button\",{onClick:function onClick(){setConfig(getRandomStyle());},type:\"button\",className:\"mb-3 mr-6 md:mb-0 focus:ring-2 focus:ring-offset-2 focus:ring-black hover:bg-gray-50 outline-none flex items-center justify-center w-full md:w-60 border-3 border-black text-black font-bold py-2 px-4 rounded-full\"},React.createElement(Image,{src:\"/icon/dice.svg\",alt:t('random'),width:28,height:28}),React.createElement(\"span\",{className:\"ml-3\"},t('random'))),React.createElement(\"div\",{className:\"flex\"},React.createElement(\"button\",{type:\"button\",onClick:downloadAvatar,className:\"focus:ring-2 ml-6 focus:ring-offset-2 focus:ring-black hover:bg-gray-50 outline-none select-none flex items-center justify-center md:w-52 border-3 border-black text-black font-bold py-2 px-4 rounded-full rounded-r-none flex-grow\"},React.createElement(Image,{src:\"/icon/download.svg\",alt:t('download'),width:28,height:28}),React.createElement(\"span\",{className:\"ml-3\"},t('download'))),React.createElement(\"div\",{className:\"border-3 border-black rounded-full flex items-center rounded-l-none border-l-0 relative\"},React.createElement(\"select\",{className:\"appearance-none focus:outline-none select-none bg-transparent h-full w-20 pl-4 pr-7\",onChange:function onChange(e){return setImageType(e.target.value);}},React.createElement(\"option\",{value:\"png\"},\".PNG\"),React.createElement(\"option\",{value:\"svg\"},\".SVG\")),React.createElement(\"svg\",{width:\"10px\",height:\"6px\",viewBox:\"0 0 10 6\",version:\"1.1\",xmlns:\"http://www.w3.org/2000/svg\",className:\"absolute right-3\"},React.createElement(\"g\",{stroke:\"none\",strokeWidth:\"1\",fill:\"none\",fillRule:\"evenodd\",strokeLinecap:\"round\",strokeLinejoin:\"round\"},React.createElement(\"g\",{id:\"a\",transform:\"translate(1.000000, 1.000000)\",stroke:\"#000000\",strokeWidth:\"2\"},React.createElement(\"polyline\",{points:\"8 0 4 4 0 0\"}))))))))));}","map":{"version":3,"sources":["E:/scaffold-eth/packages/avatar-metaverse/src/pages/components/AvatarEditor/index.tsx"],"names":["AvatarStyleCount","CompatibleAgents","DefaultBackgroundConfig","ShapeStyleMapping","SVGFilter","getRandomStyle","Image","useState","useEffect","html2canvas","useRouter","ga","useTranslation","SelectionWrapper","DownloadModal","EmbedModal","PaletteModal","AvatarEditor","router","config","setConfig","preview","setPreview","imageType","setImageType","showDownloadModal","setDownloadModal","showEmbedModal","setEmbedModal","showPaletteModal","setPaletteModal","flip","setFlip","background","setBackground","imageDataURL","setImageDataURL","t","asPath","route","query","params","Object","keys","reduce","prev","next","Boolean","Number","console","log","color","shape","generatePreview","flipped","Promise","all","map","type","require","svgRaw","default","replace","groups","previewSvg","join","trim","switchConfig","newIdx","downloadAvatar","dom","document","querySelector","logging","scale","window","devicePixelRatio","width","offsetWidth","height","offsetHeight","canvas","userAgent","navigator","toLowerCase","isNeedCompatible","some","agent","indexOf","event","action","imageURL","toDataURL","svgElement","svg","XMLSerializer","serializeToString","btoa","a","createElement","href","download","Date","getTime","click","onOpenEmbedModal","onOpenPaletteModal","backgroundColor","__html","e","target","value"],"mappings":"mhCAAA,OACEA,gBADF,CAEEC,gBAFF,CAGEC,uBAHF,CAIEC,iBAJF,CAKEC,SALF,KAMO,SANP,CAaA,OAASC,cAAT,KAA+B,SAA/B,CACA,MAAOC,CAAAA,KAAP,KAAkB,YAAlB,CACA,OAASC,QAAT,CAAmBC,SAAnB,KAAoC,OAApC,CACA,MAAOC,CAAAA,WAAP,KAAwB,aAAxB,CACA,OAASC,SAAT,KAA0B,aAA1B,CACA,MAAO,GAAKC,CAAAA,EAAZ,KAAoB,UAApB,CACA,OAASC,cAAT,KAA+B,cAA/B,CACA,MAAOC,CAAAA,gBAAP,KAA6B,oBAA7B,CACA,MAAOC,CAAAA,aAAP,KAA0B,mBAA1B,CACA,MAAOC,CAAAA,UAAP,KAAuB,gBAAvB,CACA,MAAOC,CAAAA,YAAP,KAAyB,kBAAzB,CAEA,cAAe,SAASC,CAAAA,YAAT,EAAwB,CACrC,GAAMC,CAAAA,MAAM,CAAGR,SAAS,EAAxB,CAEA,cAA4BH,QAAQ,kBAAMF,cAAc,EAApB,EAApC,wCAAOc,MAAP,eAAeC,SAAf,eACA,eAA8Bb,QAAQ,CAAC,EAAD,CAAtC,yCAAOc,OAAP,eAAgBC,UAAhB,eACA,eAAkCf,QAAQ,CAAC,KAAD,CAA1C,yCAAOgB,SAAP,eAAkBC,YAAlB,eACA,eAA8CjB,QAAQ,CAAC,KAAD,CAAtD,yCAAOkB,iBAAP,eAA0BC,gBAA1B,eACA,eAAwCnB,QAAQ,CAAC,KAAD,CAAhD,0CAAOoB,cAAP,gBAAuBC,aAAvB,gBACA,gBAA4CrB,QAAQ,CAAC,KAAD,CAApD,2CAAOsB,gBAAP,gBAAyBC,eAAzB,gBACA,gBAAwBvB,QAAQ,CAAC,KAAD,CAAhC,2CAAOwB,IAAP,gBAAaC,OAAb,gBACA,gBAAoCzB,QAAQ,CAC1CL,uBAD0C,CAA5C,2CAAO+B,UAAP,gBAAmBC,aAAnB,gBAKA,gBAAwC3B,QAAQ,CAAC,WAAD,CAAhD,2CAAO4B,YAAP,gBAAqBC,eAArB,gBAEA,oBAAcxB,cAAc,CAAC,QAAD,CAA5B,CAAQyB,CAAR,iBAAQA,CAAR,CAGA7B,SAAS,CAAC,UAAM,CACd,GAAIU,MAAM,CAACoB,MAAP,GAAkBpB,MAAM,CAACqB,KAA7B,CAAoC,8CAClC,GAAQC,CAAAA,KAAR,CAAkBtB,MAAlB,CAAQsB,KAAR,CAEA,GAAMC,CAAAA,MAAM,CAAGC,MAAM,CAACC,IAAP,CAAYH,KAAZ,EAAmBI,MAAnB,CACb,SAACC,IAAD,CAAOC,IAAP,QAAgB,UAAcD,IAAd,oBAAuBC,IAAvB,CAA8BN,KAAK,CAACM,IAAD,CAAnC,EAAhB,EADa,CAEb,EAFa,CAAf,CAIA1B,SAAS,gCAAMD,MAAN,EAAiBsB,MAAjB,EAAT,CACAT,OAAO,CAACe,OAAO,CAACC,MAAM,eAACP,MAAM,CAACV,IAAR,qBAAgB,CAAhB,CAAP,CAAR,CAAP,CACAkB,OAAO,CAACC,GAAR,CAAYT,MAAZ,EAEAP,aAAa,CAAC,CACZiB,KAAK,gBAAEV,MAAM,CAACU,KAAT,sBAAkB,oBADX,CAEZC,KAAK,gBAAEX,MAAM,CAACW,KAAT,sBAAkB,MAFX,CAAD,CAAb,CAID,CACF,CAjBQ,CAiBN,CAAClC,MAAD,CAjBM,CAAT,CAmBA,GAAMmC,CAAAA,eAAe,CAAG,QAAlBA,CAAAA,eAAkB,CAAOC,OAAP,sMACDC,OAAO,CAACC,GAAR,CACnBd,MAAM,CAACC,IAAP,CAAY3C,gBAAZ,EAA8ByD,GAA9B,CAAkC,iBAAOC,IAAP,+KAGxBC,OAAO,yCAAyCD,IAAzC,KACXvC,MAAM,CAACuC,IAAD,CADK,QAHiB,SAE1BE,MAF0B,eAM9BC,OAN8B,4DAOCH,IAPD,QAQ9BA,IAAI,GAAK,MAAT,CAAkB,gBAAlB,CAAqC,EARP,OAS5BJ,OAAO,CAAG,6CAAH,CAAmD,EAT9B,gBAUhCM,MAAM,CAACE,OAAP,CAAe,cAAf,CAA+B,EAA/B,EAAmCA,OAAnC,CAA2C,QAA3C,CAAqD,EAArD,CAVgC,wFAAlC,CADmB,CADC,SAChBC,MADgB,gBAiBhBC,UAjBgB,CAkBpB,8FACE5D,SADF,sEAGI2D,MAAM,CAACE,IAAP,CAAY,MAAZ,CAHJ,+BAMGC,IANH,GAOGJ,OAPH,CAOW,UAPX,CAOuB,EAPvB,CAlBoB,CA2BtBxC,UAAU,CAAC0C,UAAD,CAAV,CA3BsB,sEAAxB,CA8BAxD,SAAS,CAAC,UAAM,CACd6C,eAAe,CAACtB,IAAD,CAAf,CACD,CAFQ,CAEN,CAACZ,MAAD,CAASY,IAAT,CAFM,CAAT,CAIA,GAAMoC,CAAAA,aAAY,CAAG,QAAfA,CAAAA,YAAe,CAACT,IAAD,CAAsB,CACzC,GAAMU,CAAAA,MAAM,CAAG,CAACjD,MAAM,CAACuC,IAAD,CAAN,CAAe,CAAhB,GAAsB1D,gBAAgB,CAAC0D,IAAD,CAAhB,CAAyB,CAA/C,CAAf,CACAvC,MAAM,CAACuC,IAAD,CAAN,CAAeU,MAAf,CACAhD,SAAS,kBAAMD,MAAN,EAAT,CACD,CAJD,CAMA,GAAMkD,CAAAA,cAAc,CAAG,QAAjBA,CAAAA,cAAiB,kMACfC,GADe,CACIC,QAAQ,CAACC,aAAT,CACvB,iBADuB,CADJ,mDAKA/D,WAAW,CAAC6D,GAAD,CAAM,CACpCG,OAAO,CAAE,KAD2B,CAEpCC,KAAK,CAAEC,MAAM,CAACC,gBAFsB,CAGpCC,KAAK,CAAEP,GAAG,CAACQ,WAHyB,CAIpCC,MAAM,CAAET,GAAG,CAACU,YAJwB,CAAN,CALX,SAKfC,MALe,gBAWfC,SAXe,CAWHP,MAAM,CAACQ,SAAP,CAAiBD,SAAjB,CAA2BE,WAA3B,EAXG,CAYfC,gBAZe,CAYIpF,gBAAgB,CAACqF,IAAjB,CACvB,SAACC,KAAD,QAAWL,CAAAA,SAAS,CAACM,OAAV,CAAkBD,KAAlB,GAA4B,CAAvC,EADuB,CAZJ,CAiBrB5E,EAAE,CAAC8E,KAAH,CAAS,CAAEC,MAAM,CAAE,UAAV,CAAsBjD,MAAM,kBAAOtB,MAAP,CAA5B,CAAT,EAjBqB,KAqBjBI,SAAS,GAAK,KArBG,4BAsBnBoE,QAAQ,CAAGV,MAAM,CAACW,SAAP,EAAX,CAtBmB,gCAwBbC,UAxBa,CAwBAvB,GAAG,CAACE,aAAJ,CAAkB,KAAlB,CAxBA,IAyBdqB,UAzBc,qEA6BbC,GA7Ba,CA6BP,GAAIC,CAAAA,aAAJ,GAAoBC,iBAApB,CAAsCH,UAAtC,CA7BO,CA8BnBF,QAAQ,8BAAgChB,MAAM,CAACsB,IAAP,CAAYH,GAAZ,CAAxC,CA9BmB,YAkCjBT,gBAlCiB,2BAmCnBjD,eAAe,CAACuD,QAAD,CAAf,CACAjE,gBAAgB,CAAC,IAAD,CAAhB,CApCmB,0CAwCfwE,CAxCe,CAwCX3B,QAAQ,CAAC4B,aAAT,CAAuB,GAAvB,CAxCW,CA0CrBD,CAAC,CAACE,IAAF,CAAST,QAAT,CACAO,CAAC,CAACG,QAAF,kBAA8B,GAAIC,CAAAA,IAAJ,GAAWC,OAAX,EAA9B,KAAsDhF,SAAtD,CACA2E,CAAC,CAACM,KAAF,GA5CqB,uEAAvB,CA+CA,GAAMC,CAAAA,gBAAgB,CAAG,QAAnBA,CAAAA,gBAAmB,EAAM,CAC7B7E,aAAa,CAAC,IAAD,CAAb,CAEAjB,EAAE,CAAC8E,KAAH,CAAS,CAAEC,MAAM,CAAE,OAAV,CAAmBjD,MAAM,kBAAOtB,MAAP,CAAzB,CAAT,EACD,CAJD,CAMA,GAAMuF,CAAAA,kBAAkB,CAAG,QAArBA,CAAAA,kBAAqB,EAAM,CAC/B5E,eAAe,CAAC,IAAD,CAAf,CACD,CAFD,CAIA,MACE,yCACGL,iBAAiB,EAChB,oBAAC,aAAD,EACE,QAAQ,CAAE,mBAAM,CACdC,gBAAgB,CAAC,KAAD,CAAhB,CACD,CAHH,CAIE,KAAK,CAAES,YAJT,EAFJ,CASGR,cAAc,EACb,oBAAC,UAAD,EACE,QAAQ,CAAE,mBAAM,CACdC,aAAa,CAAC,KAAD,CAAb,CACD,CAHH,CAIE,MAAM,gCACDT,MADC,MAEJY,IAAI,CAAEiB,MAAM,CAACjB,IAAD,CAFR,CAGJoB,KAAK,CAAElB,UAAU,CAACkB,KAHd,CAIJC,KAAK,CAAEnB,UAAU,CAACmB,KAJd,EAJR,CAUE,SAAS,CAAE7B,SAVb,EAVJ,CAuBGM,gBAAgB,EACf,oBAAC,YAAD,EACE,QAAQ,CAAE,mBAAM,CACdC,eAAe,CAAC,KAAD,CAAf,CACD,CAHH,CAIE,QAAQ,CAAE,kBAACG,UAAD,CAAwC,CAChDC,aAAa,kBAAMD,UAAN,EAAb,CACAH,eAAe,CAAC,KAAD,CAAf,CACD,CAPH,CAQE,gBAAgB,CAAEG,UARpB,EAxBJ,CAmCE,2BAAK,SAAS,CAAC,2CAAf,EACE,2BACE,KAAK,CAAE,CACL0E,eAAe,CACb1E,UAAU,CAACmB,KAAX,GAAqB,MAArB,CACIlD,uBAAuB,CAACiD,KAD5B,CAEIlB,UAAU,CAACkB,KAJZ,CADT,CAOE,EAAE,CAAC,gBAPL,CAQE,SAAS,8BACPhD,iBAAiB,CAAC8B,UAAU,CAACmB,KAAZ,CATrB,CAWE,uBAAuB,CAAE,CACvBwD,MAAM,CAAEvF,OADe,CAX3B,EADF,CAgBE,2BAAK,SAAS,CAAC,gBAAf,EACE,2BAAK,SAAS,CAAC,mCAAf,EACE,2BAAK,SAAS,CAAC,cAAf,EAA+BgB,CAAC,CAAC,QAAD,CAAhC,CADF,CAEE,+BACE,8BACE,WAAUA,CAAC,CAAC,MAAD,CADb,CAEE,SAAS,CAAC,iCAFZ,CAGE,OAAO,CAAE,kBAAM,CACbL,OAAO,CAAC,CAACD,IAAF,CAAP,CACD,CALH,EAOE,oBAAC,KAAD,EACE,KAAK,CAAE,EADT,CAEE,MAAM,CAAE,EAFV,CAGE,GAAG,CAAEA,IAAI,CAAG,qBAAH,CAA2B,sBAHtC,EAPF,CADF,CAcE,8BACE,WAAUM,CAAC,CAAC,YAAD,CADb,CAEE,SAAS,CAAC,sCAFZ,CAGE,OAAO,CAAEqE,kBAHX,EAKE,oBAAC,KAAD,EAAO,KAAK,CAAE,EAAd,CAAkB,MAAM,CAAE,EAA1B,CAA8B,GAAG,CAAC,mBAAlC,EALF,CAdF,CAFF,CADF,CA0BE,2BAAK,SAAS,CAAC,mFAAf,EACGhE,MAAM,CAACC,IAAP,CAAY3C,gBAAZ,EAA8ByD,GAA9B,CAAkC,SAACC,IAAD,QACjC,4BAAK,GAAG,CAAEA,IAAV,EACE,oBAAC,gBAAD,EACE,YAAY,CAAE,uBAAM,CAClBS,aAAY,CAACT,IAAD,CAAZ,CACD,CAHH,CAIE,OAAO,CAAErB,CAAC,CAACqB,IAAD,CAJZ,EAME,oBAAC,KAAD,EACE,GAAG,iBAAkBA,IAAlB,KAA0BA,IAA1B,KACDvC,MAAM,CAACuC,IAAD,CADL,OADL,CAIE,KAAK,CAAE,EAJT,CAKE,MAAM,CAAE,EALV,EANF,CADF,CADiC,EAAlC,CADH,CA1BF,CA8CE,2BAAK,SAAS,CAAC,2EAAf,EACE,8BACE,OAAO,CAAE,kBAAM,CACbtC,SAAS,CAACf,cAAc,EAAf,CAAT,CACD,CAHH,CAIE,IAAI,CAAC,QAJP,CAKE,SAAS,CAAC,qNALZ,EAOE,oBAAC,KAAD,EACE,GAAG,CAAC,gBADN,CAEE,GAAG,CAAEgC,CAAC,CAAC,QAAD,CAFR,CAGE,KAAK,CAAE,EAHT,CAIE,MAAM,CAAE,EAJV,EAPF,CAaE,4BAAM,SAAS,CAAC,MAAhB,EAAwBA,CAAC,CAAC,QAAD,CAAzB,CAbF,CADF,CA6BE,2BAAK,SAAS,CAAC,MAAf,EACE,8BACE,IAAI,CAAC,QADP,CAEE,OAAO,CAAEgC,cAFX,CAGE,SAAS,CAAC,sOAHZ,EAKE,oBAAC,KAAD,EACE,GAAG,CAAC,oBADN,CAEE,GAAG,CAAEhC,CAAC,CAAC,UAAD,CAFR,CAGE,KAAK,CAAE,EAHT,CAIE,MAAM,CAAE,EAJV,EALF,CAWE,4BAAM,SAAS,CAAC,MAAhB,EAAwBA,CAAC,CAAC,UAAD,CAAzB,CAXF,CADF,CAcE,2BAAK,SAAS,CAAC,yFAAf,EACE,8BACE,SAAS,CAAC,qFADZ,CAEE,QAAQ,CAAE,kBAACwE,CAAD,QAAOrF,CAAAA,YAAY,CAACqF,CAAC,CAACC,MAAF,CAASC,KAAV,CAAnB,EAFZ,EAIE,8BAAQ,KAAK,CAAC,KAAd,SAJF,CAKE,8BAAQ,KAAK,CAAC,KAAd,SALF,CADF,CAQE,2BACE,KAAK,CAAC,MADR,CAEE,MAAM,CAAC,KAFT,CAGE,OAAO,CAAC,UAHV,CAIE,OAAO,CAAC,KAJV,CAKE,KAAK,CAAC,4BALR,CAME,SAAS,CAAC,kBANZ,EAQE,yBACE,MAAM,CAAC,MADT,CAEE,WAAW,CAAC,GAFd,CAGE,IAAI,CAAC,MAHP,CAIE,QAAQ,CAAC,SAJX,CAKE,aAAa,CAAC,OALhB,CAME,cAAc,CAAC,OANjB,EAQE,yBACE,EAAE,CAAC,GADL,CAEE,SAAS,CAAC,+BAFZ,CAGE,MAAM,CAAC,SAHT,CAIE,WAAW,CAAC,GAJd,EAME,gCAAU,MAAM,CAAC,aAAjB,EANF,CARF,CARF,CARF,CAdF,CA7BF,CA9CF,CAhBF,CAnCF,CADF,CAsLD","sourcesContent":["import {\n  AvatarStyleCount,\n  CompatibleAgents,\n  DefaultBackgroundConfig,\n  ShapeStyleMapping,\n  SVGFilter,\n} from '@/const';\nimport {\n  AvatarPart,\n  ImageType,\n  AvatarConfig,\n  AvatarBackgroundConfig,\n} from '@/types';\nimport { getRandomStyle } from '@/utils';\nimport Image from 'next/image';\nimport { useState, useEffect } from 'react';\nimport html2canvas from 'html2canvas';\nimport { useRouter } from 'next/router';\nimport * as ga from '@/lib/ga';\nimport { useTranslation } from 'next-i18next';\nimport SelectionWrapper from './SelectionWrapper';\nimport DownloadModal from '../Modal/Download';\nimport EmbedModal from '../Modal/Embed';\nimport PaletteModal from '../Modal/Palette';\n\nexport default function AvatarEditor() {\n  const router = useRouter();\n\n  const [config, setConfig] = useState({ ...getRandomStyle() });\n  const [preview, setPreview] = useState('');\n  const [imageType, setImageType] = useState('png' as ImageType);\n  const [showDownloadModal, setDownloadModal] = useState(false);\n  const [showEmbedModal, setEmbedModal] = useState(false);\n  const [showPaletteModal, setPaletteModal] = useState(false);\n  const [flip, setFlip] = useState(false);\n  const [background, setBackground] = useState<AvatarBackgroundConfig>(\n    DefaultBackgroundConfig,\n  );\n\n  // default placeholder for compatible modal\n  const [imageDataURL, setImageDataURL] = useState('/logo.gif');\n\n  const { t } = useTranslation('common');\n\n  // hack\n  useEffect(() => {\n    if (router.asPath !== router.route) {\n      const { query } = router;\n      // query string to number\n      const params = Object.keys(query).reduce(\n        (prev, next) => Object.assign(prev, { [next]: query[next] }),\n        {},\n      ) as AvatarConfig;\n      setConfig({ ...config, ...params });\n      setFlip(Boolean(Number(params.flip ?? 0)));\n      console.log(params);\n\n      setBackground({\n        color: params.color ?? 'rgba(255, 0, 0, 0)',\n        shape: params.shape ?? 'none',\n      });\n    }\n  }, [router]);\n\n  const generatePreview = async (flipped: boolean) => {\n    const groups = await Promise.all(\n      Object.keys(AvatarStyleCount).map(async (type) => {\n        /* eslint-disable */\n        const svgRaw = (\n          await require(`!!raw-loader!@/public/avatar/preview/${type}/${\n            config[type as AvatarPart]\n          }.svg`)\n        ).default;\n        return `\\n<g id=\"notion-avatar-${type}\" ${\n          type === 'face' ? 'fill=\"#ffffff\"' : ''\n        } ${flipped ? 'transform=\"scale(-1,1) translate(-1080, 0)\"' : ''}>\\n\n      ${svgRaw.replace(/<svg.*(?=>)>/, '').replace('</svg>', '')}\n    \\n</g>\\n`;\n      }),\n    );\n\n    const previewSvg =\n      `<svg viewBox=\"0 0 1080 1080\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n      ${SVGFilter}\n      <g id=\"notion-avatar\" filter=\"url(#filter)\">\n        ${groups.join('\\n\\n')}\n      </g>\n      </svg>`\n        .trim()\n        .replace(/(\\n|\\t)/g, '');\n\n    setPreview(previewSvg);\n  };\n\n  useEffect(() => {\n    generatePreview(flip);\n  }, [config, flip]);\n\n  const switchConfig = (type: AvatarPart) => {\n    const newIdx = (config[type] + 1) % (AvatarStyleCount[type] + 1);\n    config[type] = newIdx;\n    setConfig({ ...config });\n  };\n\n  const downloadAvatar = async () => {\n    const dom: HTMLElement = document.querySelector(\n      '#avatar-preview',\n    ) as HTMLElement;\n\n    const canvas = await html2canvas(dom, {\n      logging: false,\n      scale: window.devicePixelRatio,\n      width: dom.offsetWidth,\n      height: dom.offsetHeight,\n    });\n    const userAgent = window.navigator.userAgent.toLowerCase();\n    const isNeedCompatible = CompatibleAgents.some(\n      (agent) => userAgent.indexOf(agent) >= 0,\n    );\n\n    // record download action\n    ga.event({ action: 'download', params: { ...config } });\n\n    // base64 only support png svg for now, maybe more change it to Map\n    let imageURL;\n    if (imageType === 'png') {\n      imageURL = canvas.toDataURL();\n    } else {\n      const svgElement = dom.querySelector('svg');\n      if (!svgElement) {\n        // not generate for some reason\n        return;\n      }\n      const svg = new XMLSerializer().serializeToString(svgElement);\n      imageURL = `data:image/svg+xml;base64,${window.btoa(svg)}`;\n    }\n\n    // compatible for browsers which don't surpport dwonload attribution\n    if (isNeedCompatible) {\n      setImageDataURL(imageURL);\n      setDownloadModal(true);\n      return;\n    }\n\n    const a = document.createElement('a');\n\n    a.href = imageURL;\n    a.download = `notion-avatar-${new Date().getTime()}.${imageType}`;\n    a.click();\n  };\n\n  const onOpenEmbedModal = () => {\n    setEmbedModal(true);\n    // record embed action\n    ga.event({ action: 'embed', params: { ...config } });\n  };\n\n  const onOpenPaletteModal = () => {\n    setPaletteModal(true);\n  };\n\n  return (\n    <>\n      {showDownloadModal && (\n        <DownloadModal\n          onCancel={() => {\n            setDownloadModal(false);\n          }}\n          image={imageDataURL}\n        />\n      )}\n      {showEmbedModal && (\n        <EmbedModal\n          onCancel={() => {\n            setEmbedModal(false);\n          }}\n          config={{\n            ...config,\n            flip: Number(flip),\n            color: background.color,\n            shape: background.shape,\n          }}\n          imageType={imageType}\n        />\n      )}\n      {showPaletteModal && (\n        <PaletteModal\n          onCancel={() => {\n            setPaletteModal(false);\n          }}\n          onSelect={(background: AvatarBackgroundConfig) => {\n            setBackground({ ...background });\n            setPaletteModal(false);\n          }}\n          backgroundConfig={background}\n        />\n      )}\n      <div className=\"flex justify-center items-center flex-col\">\n        <div\n          style={{\n            backgroundColor:\n              background.shape === 'none'\n                ? DefaultBackgroundConfig.color\n                : background.color,\n          }}\n          id=\"avatar-preview\"\n          className={`w-48 h-48 md:w-72 md:h-72 ${\n            ShapeStyleMapping[background.shape]\n          }`}\n          dangerouslySetInnerHTML={{\n            __html: preview,\n          }}\n        />\n        <div className=\"w-5/6 md:w-2/3\">\n          <div className=\"flex justify-between items-center\">\n            <div className=\"text-lg my-5\">{t('choose')}</div>\n            <div>\n              <button\n                data-tip={t('flip')}\n                className=\"w-8 h-8 sm:w-12 sm:h-12 tooltip\"\n                onClick={() => {\n                  setFlip(!flip);\n                }}\n              >\n                <Image\n                  width={30}\n                  height={30}\n                  src={flip ? '/icon/flip-left.svg' : '/icon/flip-right.svg'}\n                />\n              </button>\n              <button\n                data-tip={t('background')}\n                className=\"w-8 h-8 sm:w-12 sm:h-12 tooltip ml-2\"\n                onClick={onOpenPaletteModal}\n              >\n                <Image width={30} height={30} src=\"/icon/palette.svg\" />\n              </button>\n            </div>\n          </div>\n          <div className=\"grid gap-y-4 justify-items-center justify-between grid-rows-2 grid-cols-5 lg:flex\">\n            {Object.keys(AvatarStyleCount).map((type) => (\n              <div key={type}>\n                <SelectionWrapper\n                  switchConfig={() => {\n                    switchConfig(type as AvatarPart);\n                  }}\n                  tooltip={t(type)}\n                >\n                  <Image\n                    src={`/avatar/part/${type}/${type}-${\n                      config[type as AvatarPart]\n                    }.svg`}\n                    width={30}\n                    height={30}\n                  />\n                </SelectionWrapper>\n              </div>\n            ))}\n          </div>\n          <div className=\"flex flex-col gap-x-2 md:flex-row mt-8 justify-center  w-full select-none\">\n            <button\n              onClick={() => {\n                setConfig(getRandomStyle());\n              }}\n              type=\"button\"\n              className=\"mb-3 mr-6 md:mb-0 focus:ring-2 focus:ring-offset-2 focus:ring-black hover:bg-gray-50 outline-none flex items-center justify-center w-full md:w-60 border-3 border-black text-black font-bold py-2 px-4 rounded-full\"\n            >\n              <Image\n                src=\"/icon/dice.svg\"\n                alt={t('random')}\n                width={28}\n                height={28}\n              />\n              <span className=\"ml-3\">{t('random')}</span>\n            </button>\n            {/*<button*/}\n            {/*  onClick={onOpenEmbedModal}*/}\n            {/*  type=\"button\"*/}\n            {/*  className=\"mb-3 md:mb-0 focus:ring-2 focus:ring-offset-2 focus:ring-black hover:bg-gray-50 outline-none flex items-center justify-center w-full md:w-60 border-3 border-black text-black font-bold py-2 px-4 rounded-full\"*/}\n            {/*>*/}\n            {/*  <Image*/}\n            {/*    src=\"/icon/code.svg\"*/}\n            {/*    alt={t('embed')}*/}\n            {/*    width={28}*/}\n            {/*    height={28}*/}\n            {/*  />*/}\n            {/*  <span className=\"ml-3\">{t('embed')}</span>*/}\n            {/*</button>*/}\n            <div className=\"flex\">\n              <button\n                type=\"button\"\n                onClick={downloadAvatar}\n                className=\"focus:ring-2 ml-6 focus:ring-offset-2 focus:ring-black hover:bg-gray-50 outline-none select-none flex items-center justify-center md:w-52 border-3 border-black text-black font-bold py-2 px-4 rounded-full rounded-r-none flex-grow\"\n              >\n                <Image\n                  src=\"/icon/download.svg\"\n                  alt={t('download')}\n                  width={28}\n                  height={28}\n                />\n                <span className=\"ml-3\">{t('download')}</span>\n              </button>\n              <div className=\"border-3 border-black rounded-full flex items-center rounded-l-none border-l-0 relative\">\n                <select\n                  className=\"appearance-none focus:outline-none select-none bg-transparent h-full w-20 pl-4 pr-7\"\n                  onChange={(e) => setImageType(e.target.value as ImageType)}\n                >\n                  <option value=\"png\">.PNG</option>\n                  <option value=\"svg\">.SVG</option>\n                </select>\n                <svg\n                  width=\"10px\"\n                  height=\"6px\"\n                  viewBox=\"0 0 10 6\"\n                  version=\"1.1\"\n                  xmlns=\"http://www.w3.org/2000/svg\"\n                  className=\"absolute right-3\"\n                >\n                  <g\n                    stroke=\"none\"\n                    strokeWidth=\"1\"\n                    fill=\"none\"\n                    fillRule=\"evenodd\"\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                  >\n                    <g\n                      id=\"a\"\n                      transform=\"translate(1.000000, 1.000000)\"\n                      stroke=\"#000000\"\n                      strokeWidth=\"2\"\n                    >\n                      <polyline points=\"8 0 4 4 0 0\"></polyline>\n                    </g>\n                  </g>\n                </svg>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}